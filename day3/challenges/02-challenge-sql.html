<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Challenge 2: Azure SQL DB (optional) | Azure Developer College</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/trainingdays/assets/css/0.styles.307428eb.css" as="style"><link rel="preload" href="/trainingdays/assets/js/app.f35de7a7.js" as="script"><link rel="preload" href="/trainingdays/assets/js/2.989cf5bf.js" as="script"><link rel="preload" href="/trainingdays/assets/js/25.83c4ee46.js" as="script"><link rel="prefetch" href="/trainingdays/assets/js/10.780aeda4.js"><link rel="prefetch" href="/trainingdays/assets/js/11.4c6423b8.js"><link rel="prefetch" href="/trainingdays/assets/js/12.fcf4e990.js"><link rel="prefetch" href="/trainingdays/assets/js/13.e01097b2.js"><link rel="prefetch" href="/trainingdays/assets/js/14.8555b734.js"><link rel="prefetch" href="/trainingdays/assets/js/15.e7b4cb61.js"><link rel="prefetch" href="/trainingdays/assets/js/16.ca0534a3.js"><link rel="prefetch" href="/trainingdays/assets/js/17.9f693448.js"><link rel="prefetch" href="/trainingdays/assets/js/18.2f2093d6.js"><link rel="prefetch" href="/trainingdays/assets/js/19.9e4b55d0.js"><link rel="prefetch" href="/trainingdays/assets/js/20.476d977c.js"><link rel="prefetch" href="/trainingdays/assets/js/21.b31a3392.js"><link rel="prefetch" href="/trainingdays/assets/js/22.3f90568e.js"><link rel="prefetch" href="/trainingdays/assets/js/23.d6548904.js"><link rel="prefetch" href="/trainingdays/assets/js/24.83e5af0f.js"><link rel="prefetch" href="/trainingdays/assets/js/26.e72c9381.js"><link rel="prefetch" href="/trainingdays/assets/js/27.9536bb3f.js"><link rel="prefetch" href="/trainingdays/assets/js/28.70f1ef7a.js"><link rel="prefetch" href="/trainingdays/assets/js/29.3801b9b5.js"><link rel="prefetch" href="/trainingdays/assets/js/3.2e517bab.js"><link rel="prefetch" href="/trainingdays/assets/js/30.3d0f53bb.js"><link rel="prefetch" href="/trainingdays/assets/js/31.fd5d8ddb.js"><link rel="prefetch" href="/trainingdays/assets/js/32.0e00bee7.js"><link rel="prefetch" href="/trainingdays/assets/js/33.2fb17a4b.js"><link rel="prefetch" href="/trainingdays/assets/js/34.a0a1c041.js"><link rel="prefetch" href="/trainingdays/assets/js/35.7e58dabe.js"><link rel="prefetch" href="/trainingdays/assets/js/36.f2c555a8.js"><link rel="prefetch" href="/trainingdays/assets/js/37.1ec7a02f.js"><link rel="prefetch" href="/trainingdays/assets/js/38.bb236e14.js"><link rel="prefetch" href="/trainingdays/assets/js/39.12a794aa.js"><link rel="prefetch" href="/trainingdays/assets/js/4.076fa189.js"><link rel="prefetch" href="/trainingdays/assets/js/40.f93c86e0.js"><link rel="prefetch" href="/trainingdays/assets/js/41.c39ede3a.js"><link rel="prefetch" href="/trainingdays/assets/js/42.554cec04.js"><link rel="prefetch" href="/trainingdays/assets/js/43.5bd4eeb1.js"><link rel="prefetch" href="/trainingdays/assets/js/44.74e2d89b.js"><link rel="prefetch" href="/trainingdays/assets/js/45.6f467ebc.js"><link rel="prefetch" href="/trainingdays/assets/js/46.b13f8c9f.js"><link rel="prefetch" href="/trainingdays/assets/js/47.db58a6dd.js"><link rel="prefetch" href="/trainingdays/assets/js/48.9234eefe.js"><link rel="prefetch" href="/trainingdays/assets/js/49.f520e854.js"><link rel="prefetch" href="/trainingdays/assets/js/5.cd4a6f92.js"><link rel="prefetch" href="/trainingdays/assets/js/50.f76042e4.js"><link rel="prefetch" href="/trainingdays/assets/js/51.e48d1f47.js"><link rel="prefetch" href="/trainingdays/assets/js/52.1a0f794c.js"><link rel="prefetch" href="/trainingdays/assets/js/53.34b352ea.js"><link rel="prefetch" href="/trainingdays/assets/js/54.413dfc7f.js"><link rel="prefetch" href="/trainingdays/assets/js/55.6630c97c.js"><link rel="prefetch" href="/trainingdays/assets/js/56.e0c1984b.js"><link rel="prefetch" href="/trainingdays/assets/js/57.e8b3165a.js"><link rel="prefetch" href="/trainingdays/assets/js/58.f0b5c00b.js"><link rel="prefetch" href="/trainingdays/assets/js/59.3f39eda3.js"><link rel="prefetch" href="/trainingdays/assets/js/6.08ea3b2a.js"><link rel="prefetch" href="/trainingdays/assets/js/60.1743d283.js"><link rel="prefetch" href="/trainingdays/assets/js/61.51333324.js"><link rel="prefetch" href="/trainingdays/assets/js/62.d8fe34bc.js"><link rel="prefetch" href="/trainingdays/assets/js/63.f95b8160.js"><link rel="prefetch" href="/trainingdays/assets/js/64.414eae6e.js"><link rel="prefetch" href="/trainingdays/assets/js/65.2d78468c.js"><link rel="prefetch" href="/trainingdays/assets/js/66.a7d06d35.js"><link rel="prefetch" href="/trainingdays/assets/js/67.5de73a5e.js"><link rel="prefetch" href="/trainingdays/assets/js/68.f6f4c427.js"><link rel="prefetch" href="/trainingdays/assets/js/69.aa3c0657.js"><link rel="prefetch" href="/trainingdays/assets/js/7.0e2524bf.js"><link rel="prefetch" href="/trainingdays/assets/js/70.c116a905.js"><link rel="prefetch" href="/trainingdays/assets/js/71.34bb5f4a.js"><link rel="prefetch" href="/trainingdays/assets/js/72.aa9947e8.js"><link rel="prefetch" href="/trainingdays/assets/js/73.a6dc05e7.js"><link rel="prefetch" href="/trainingdays/assets/js/74.774c0f8b.js"><link rel="prefetch" href="/trainingdays/assets/js/75.8fcc3a21.js"><link rel="prefetch" href="/trainingdays/assets/js/76.46acaa39.js"><link rel="prefetch" href="/trainingdays/assets/js/77.2df5fe59.js"><link rel="prefetch" href="/trainingdays/assets/js/78.621183e7.js"><link rel="prefetch" href="/trainingdays/assets/js/79.f73262ec.js"><link rel="prefetch" href="/trainingdays/assets/js/8.5c71bfb1.js"><link rel="prefetch" href="/trainingdays/assets/js/80.4a8fd06d.js"><link rel="prefetch" href="/trainingdays/assets/js/81.59dd494b.js"><link rel="prefetch" href="/trainingdays/assets/js/82.cae84daa.js"><link rel="prefetch" href="/trainingdays/assets/js/83.b6a17fc2.js"><link rel="prefetch" href="/trainingdays/assets/js/84.ad8a0c10.js"><link rel="prefetch" href="/trainingdays/assets/js/85.7b07e28f.js"><link rel="prefetch" href="/trainingdays/assets/js/86.40cfbbdd.js"><link rel="prefetch" href="/trainingdays/assets/js/87.4f11b827.js"><link rel="prefetch" href="/trainingdays/assets/js/88.cb9bf9cf.js"><link rel="prefetch" href="/trainingdays/assets/js/89.38bab1ab.js"><link rel="prefetch" href="/trainingdays/assets/js/9.b747e0f0.js"><link rel="prefetch" href="/trainingdays/assets/js/90.3ae9a1f4.js">
    <link rel="stylesheet" href="/trainingdays/assets/css/0.styles.307428eb.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/trainingdays/" class="home-link router-link-active"><!----> <span class="site-name">Azure Developer College</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/azuredevcollege/trainingdays" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/azuredevcollege/trainingdays" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/trainingdays/" aria-current="page" class="sidebar-link">Home</a></li><li><a href="/trainingdays/day1/" class="sidebar-link">Day 1 Azure Fundamentals &amp; Infrastructure</a></li><li><a href="/trainingdays/day2/" class="sidebar-link">Day 2 Azure Development</a></li><li><a href="/trainingdays/day3/" aria-current="page" class="sidebar-link">Day 3 Data and AI</a></li><li><a href="/trainingdays/day4/" class="sidebar-link">Day 4 DevOps and Monitoring</a></li><li><a href="/trainingdays/day5/" class="sidebar-link">Day 5 Identity and Architecture</a></li><li><a href="/trainingdays/day6/" class="sidebar-link">Day 6 Containerization</a></li><li><a href="/trainingdays/day7/" class="sidebar-link">Day 7 Kubernetes</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="challenge-2-azure-sql-db-optional"><a href="#challenge-2-azure-sql-db-optional" class="header-anchor">#</a> Challenge 2: Azure SQL DB (optional)</h1> <h2 id="here-is-what-you-will-learn-üéØ"><a href="#here-is-what-you-will-learn-üéØ" class="header-anchor">#</a> Here is what you will learn üéØ</h2> <p>In this challenge you will learn how to:</p> <ul><li>create an Azure SQL DB (Single Database)</li> <li>add Data to the Azure SQL DB</li> <li>setup Dynamic Data Masking</li></ul> <h2 id="table-of-contents"><a href="#table-of-contents" class="header-anchor">#</a> Table Of Contents</h2> <ol><li><a href="#basics">Basics</a></li> <li><a href="#deployment-models">Deployment models</a></li> <li><a href="#purchasing-models">Purchasing models</a></li> <li><a href="#create-a-single-sql-database">Create a single SQL Database</a></li> <li><a href="#add-data-to-sql-db">Add Data to SQL DB</a></li> <li><a href="#add-data-to-sql-db-using-the-azure-data-studio">Add Data to SQL DB using the Azure Data Studio</a></li> <li><a href="#setup-dynamic-data-masking">Setup Dynamic Data Masking</a></li> <li><a href="#access-management-for-azure-sql-db">Access Management for Azure SQL DB</a></li> <li><a href="#sql-database-backup-and-retention-policies-optional">SQL Database backup and retention policies (optional)</a></li> <li><a href="#connect-the-azure-sql-db-to-a-web-application-optional">Connect the Azure SQL DB to a Web Application (optional)</a></li> <li><a href="#cleanup">Cleanup</a></li></ol> <h2 id="basics"><a href="#basics" class="header-anchor">#</a> Basics</h2> <p>Azure SQL Database is a general-purpose relational database, provided as a managed service. It's based on the latest stable version of <a href="https://docs.microsoft.com/sql/sql-server/sql-server-technical-documentation?toc=/azure/sql-database/toc.json" target="_blank" rel="noopener noreferrer">Microsoft SQL Server database engine<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. In fact, the newest capabilities of SQL Server are released first to SQL Database, and then to SQL Server itself. You get the newest SQL Server capabilities with no overhead for patching or upgrading, tested across millions of databases.</p> <p>To get started with SQL Database consult the documentation <a href="https://docs.microsoft.com/azure/sql-database/sql-database-technical-overview" target="_blank" rel="noopener noreferrer">here<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <h2 id="deployment-models"><a href="#deployment-models" class="header-anchor">#</a> Deployment models</h2> <p>Let us have a look at the different deployment models of SQL Database first:</p> <p><img src="/trainingdays/assets/img/sql-database-deployment-options.508ea38a.png" alt="SQL database Deployment options"></p> <ul><li><a href="https://docs.microsoft.com/azure/azure-sql/database/single-database-overview" target="_blank" rel="noopener noreferrer">Single database<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> represents a fully managed, isolated database. You might use this option if you have modern cloud applications and microservices that need a single reliable data source. A single database is similar to a contained database in Microsoft SQL Server Database Engine.</li> <li><a href="https://docs.microsoft.com/azure/azure-sql/managed-instance/sql-managed-instance-paas-overview" target="_blank" rel="noopener noreferrer">Managed instance<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> is a fully managed instance of the Microsoft SQL Server Database Engine. It contains a set of databases that can be used together. Use this option for easy migration of on-premises SQL Server databases to the Azure cloud, and for applications that need to use the database features that SQL Server Database Engine provides.</li> <li><a href="https://docs.microsoft.com/azure/azure-sql/database/elastic-pool-overview" target="_blank" rel="noopener noreferrer">Elastic pool<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> is a collection of single databases with a shared set of resources, such as CPU or memory. Single databases can be moved into and out of an elastic pool.</li></ul> <h2 id="purchasing-models"><a href="#purchasing-models" class="header-anchor">#</a> Purchasing models</h2> <p>SQL Database offers the following purchasing models:</p> <ul><li>The vCore-based purchasing model lets you choose the number of vCores, the amount of memory, and the amount and speed of storage.</li> <li>The DTU-based purchasing model offers a blend of compute, memory, and I/O resources in three service tiers, to support light to heavy database workloads. Compute sizes within each tier provide a different mix of these resources, to which you can add additional storage resources</li> <li>The serverless model automatically scales compute based on workload demand, and bills for the amount of compute used per second. The serverless compute tier also automatically pauses databases during inactive periods when only storage is billed, and automatically resumes databases when activity returns.</li></ul> <p>You see that each purchasing model refers to compute, memory and I/O resources, because these are the most important and crtical resources a databse uses.</p> <h2 id="create-a-single-sql-database"><a href="#create-a-single-sql-database" class="header-anchor">#</a> Create a single SQL Database</h2> <p>The single database deployment option creates a database in Azure SQL Database with its own set of resources and is managed via a SQL Database server. With a single database, each database is isolated from each other and portbale, each with its own service tier within the DTU-based purchasing model or vCore-based purchasing model and a guaranteed compute size.</p> <p>Navigate to the azure portal and open the cloud shell. We use the Azure CLI to create the needed Azure resources:</p> <ol><li><p>Create a resource group:</p> <div class="language-shell extra-class"><pre class="language-shell"><code>az group create --name adc-sql-db-rg --location westeurope
</code></pre></div></li> <li><p>Create the server instance and note down the <strong>fullyQualifiedDomainName</strong> of your server from the output</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>üìù The Azure SQL Server name has to be unique.
The password should be at least 8 letters, must contain capital letters and numbers, refrain from using $.</p></div> <div class="language-shell extra-class"><pre class="language-shell"><code>az sql server create --name <span class="token operator">&lt;</span>name of the server<span class="token operator">&gt;</span> --resource-group adc-sql-db-rg --location westeurope --admin-user <span class="token operator">&lt;</span>name of your admin<span class="token operator">&gt;</span> --admin-password <span class="token operator">&lt;</span>pwd<span class="token operator">&gt;</span>
</code></pre></div></li> <li><p>Per default the access is not permitted via the Azure SQL Server. Configure the server's firewall to allow your IPv4</p> <div class="language-shell extra-class"><pre class="language-shell"><code>az sql server firewall-rule create --server <span class="token operator">&lt;</span>name of your server<span class="token operator">&gt;</span> --resource-group adc-sql-db-rg --name AllowYourIp --start-ip-address <span class="token operator">&lt;</span>your public ip<span class="token operator">&gt;</span> --end-ip-address <span class="token operator">&lt;</span>your public Ip<span class="token operator">&gt;</span>
</code></pre></div></li> <li><p>Create the SQL Database with vCore-based purchasing Gen5, 1 vCore and max 32GB in size. <a href="https://docs.microsoft.com/azure/sql-database/sql-database-service-tiers-vcore" target="_blank" rel="noopener noreferrer">Here<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> you will find a good overview of the vCore model.</p> <div class="language-shell extra-class"><pre class="language-shell"><code>az sql db create --name MSFTEmployees --resource-group adc-sql-db-rg --server <span class="token operator">&lt;</span>name of your server<span class="token operator">&gt;</span> --edition GeneralPurpose --family Gen5 --capacity <span class="token number">2</span> --max-size 32GB --zone-redundant <span class="token boolean">false</span>
</code></pre></div></li></ol> <h2 id="add-data-to-sql-db"><a href="#add-data-to-sql-db" class="header-anchor">#</a> Add Data to SQL DB</h2> <p>Now that your SQL Database is up and running it's time to add some data. First we will use the Azure CLI to do so:</p> <ol><li>Get to know your environment</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>az sql server list --resource-group adc-sql-db-rg
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code>az sql db list --resource-group adc-sql-db-rg --server <span class="token operator">&lt;</span>name of your server<span class="token operator">&gt;</span>
</code></pre></div><ol start="2"><li>If you run the command like this you are getting a lot of information to make sense of. You can restrict this by using a query:</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>az sql db list --resource-group adc-sql-db-rg --server <span class="token operator">&lt;</span>name of your server<span class="token operator">&gt;</span> --query <span class="token string">'[].{Name: name}'</span>
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code>az sql db show --resource-group adc-sql-db-rg --server <span class="token operator">&lt;</span>name of your server<span class="token operator">&gt;</span> --name MSFTEmployees --query <span class="token string">'{Name: name, maxSizeBytes: maxSizeBytes, status: status}'</span>
</code></pre></div><h3 id="connect-to-your-sql-db"><a href="#connect-to-your-sql-db" class="header-anchor">#</a> Connect to your SQL DB</h3> <div class="language-shell extra-class"><pre class="language-shell"><code>az sql db show-connection-string --name MSFTEmployees --server <span class="token operator">&lt;</span>name of your server<span class="token operator">&gt;</span> --client sqlcmd
</code></pre></div><p>For the next part to work you either have the <code>sqlcmd</code> extension or go on using the Azure Cloud Shell (PowerShell). Copy the <code>sqlcmd</code> command and enter your admin name and password. The command should look something like this:</p> <div class="language-shell extra-class"><pre class="language-shell"><code>sqlcmd -S tcp:<span class="token punctuation">[</span>Name of your Server<span class="token punctuation">]</span>.database.windows.net,1433 -d MSFTEmployees -U <span class="token operator">&lt;</span>name of your admin<span class="token operator">&gt;</span> -P <span class="token operator">&lt;</span>pwd<span class="token operator">&gt;</span> -N -l <span class="token number">30</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>üìù You might need to renew the firewall-rule at this point. The error output includes the needed IP address.</p> <div class="language-shell extra-class"><pre class="language-shell"><code>az sql server firewall-rule create --server <span class="token operator">&lt;</span>name of your server<span class="token operator">&gt;</span> --resource-group adc-sql-db-rg --name AllowYourIp --start-ip-address <span class="token operator">&lt;</span>your public ip<span class="token operator">&gt;</span> --end-ip-address <span class="token operator">&lt;</span>your public Ip<span class="token operator">&gt;</span>
</code></pre></div></div> <p>After running this you should see a <code>1&gt;</code>. Now you can run SQL Queries. If you are unfamiliar with their Syntax feel free to take some time getting used to it:</p> <ol><li>Add a table.</li></ol> <div class="language-Sql extra-class"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> CEOs <span class="token punctuation">(</span>EmployerID <span class="token keyword">int</span><span class="token punctuation">,</span> LastName <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span> FirstName <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Age <span class="token keyword">int</span><span class="token punctuation">,</span> StartYear <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
GO
</code></pre></div><ol start="2"><li>Add Data to your table</li></ol> <div class="language-Sql extra-class"><pre class="language-sql"><code><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> CEOs <span class="token punctuation">(</span>EmployerID<span class="token punctuation">,</span> LastName<span class="token punctuation">,</span> FirstName<span class="token punctuation">,</span> Age<span class="token punctuation">,</span> StartYear<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">,</span> <span class="token string">'Nadella'</span><span class="token punctuation">,</span> <span class="token string">'Satya'</span><span class="token punctuation">,</span> <span class="token number">51</span><span class="token punctuation">,</span> <span class="token number">2014</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
GO
</code></pre></div><ol start="3"><li>Update the Age of Satya Nadella in the Table</li></ol> <div class="language-Sql extra-class"><pre class="language-sql"><code><span class="token keyword">UPDATE</span> CEOs <span class="token keyword">SET</span> Age<span class="token operator">=</span><span class="token number">53</span> <span class="token keyword">WHERE</span> EmployerID<span class="token operator">=</span><span class="token number">42</span><span class="token punctuation">;</span>
GO
</code></pre></div><ol start="4"><li>Query the data</li></ol> <div class="language-Sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> CEOs
GO
</code></pre></div><h2 id="setup-dynamic-data-masking"><a href="#setup-dynamic-data-masking" class="header-anchor">#</a> Setup Dynamic Data Masking</h2> <p>Dynamic data masking (DDM) limits sensitive data exposure by masking it to non-privileged users. It can be used to greatly simplify the design and coding of security in your application. Take a look at the documentation <a href="https://docs.microsoft.com/sql/relational-databases/security/dynamic-data-masking?view=sql-server-ver15" target="_blank" rel="noopener noreferrer">here<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> to get more information about Dynamic Data Masking.</p> <p><img src="data:image/png;base64,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" alt="Dynamic Data Masking"></p> <p>To see Dynamic Data Masking in action we first add a column to the CEOs table with a Data Masking Rule.</p> <p>If you have exited the sqlcmd utility program, reconnect as follows:</p> <div class="language-shell extra-class"><pre class="language-shell"><code>sqlcmd -S tcp:<span class="token punctuation">[</span>Name of your Server<span class="token punctuation">]</span>.database.windows.net,1433 -d MSFTEmployees -U <span class="token operator">&lt;</span>name of your admin<span class="token operator">&gt;</span> -P <span class="token operator">&lt;</span>pwd<span class="token operator">&gt;</span> -N -l <span class="token number">30</span>
</code></pre></div><p>Run the following after <code>1&gt;</code>:</p> <ol><li>Add the column email and mask it.</li></ol> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> <span class="token punctuation">[</span>dbo<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>CEOs<span class="token punctuation">]</span>
<span class="token keyword">ADD</span> Email <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> MASKED <span class="token keyword">WITH</span> <span class="token punctuation">(</span><span class="token keyword">FUNCTION</span> <span class="token operator">=</span> <span class="token string">'EMAIL()'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
GO
</code></pre></div><ol start="2"><li>Run another query to add more information to the table:</li></ol> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> CEOs <span class="token punctuation">(</span>EmployerID<span class="token punctuation">,</span> LastName<span class="token punctuation">,</span> FirstName<span class="token punctuation">,</span> Age<span class="token punctuation">,</span> StartYear<span class="token punctuation">,</span> Email<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'Gates'</span><span class="token punctuation">,</span> <span class="token string">'Bill'</span><span class="token punctuation">,</span> <span class="token number">65</span><span class="token punctuation">,</span> <span class="token number">1975</span><span class="token punctuation">,</span> <span class="token string">'bgates@microsoft.com'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">UPDATE</span> CEOs <span class="token keyword">SET</span> Email<span class="token operator">=</span><span class="token string">'snadella@microsoft.com'</span> <span class="token keyword">WHERE</span> EmployerID<span class="token operator">=</span><span class="token number">42</span><span class="token punctuation">;</span>
GO
</code></pre></div><p>When we select the top 1000 rows of the Contacts table we still see the email's actual value.</p> <p><img src="/trainingdays/assets/img/sqlunmasked.e7150a6c.png" alt="Not Masked"></p> <p>The reason behind this is that the account we have used has elevated privileges. To show you how Dynamic Data Masking works we create a user and grant select on CEOs.</p> <ol start="3"><li>Run the following:</li></ol> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">USER</span> TestUser WITHOUT LOGIN<span class="token punctuation">;</span>
<span class="token keyword">GRANT</span> <span class="token keyword">SELECT</span> <span class="token keyword">ON</span> CEOs <span class="token keyword">TO</span> TestUser<span class="token punctuation">;</span>
GO

<span class="token keyword">EXECUTE</span> <span class="token keyword">AS</span> <span class="token keyword">USER</span> <span class="token operator">=</span> <span class="token string">'TestUser'</span><span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> CEOs<span class="token punctuation">;</span>
GO
</code></pre></div><p><img src="/trainingdays/assets/img/sqlmasked.84c480df.png" alt="Masked"></p> <ol start="4"><li>To exit the sqlcmd utility program enter <code>exit</code>.</li></ol> <h2 id="sql-database-backup-and-retention-policies"><a href="#sql-database-backup-and-retention-policies" class="header-anchor">#</a> SQL Database backup and retention policies</h2> <p>You make the choice between configuring your server for either locally redundant backups or geographically redundant backups at server creation.
After a server is created, the kind of redundancy it has, geographically redundant vs locally redundant, can't be switched.
While creating a server via the <code>az sql server create</code> command, the <code>--geo-redundant-backup</code> parameter decides your Backup Redundancy Option. If <code>Enabled</code>, geo redundant backups are taken. Or if <code>Disabled</code> locally redundant backups are taken.
In our current database geo redundant backups therefore are not possible.</p> <ul><li>Go to the Azure portal and navigate to your SQL server</li> <li>Under Manage Backups you will find the retention policies</li> <li>Change the retention policy for MicrosoftEmployees to Monthly Backups that should be kept for 8 weeks.</li> <li>On the Available backups tab, you will find backups from which you can restore a specific database.</li></ul> <p>As a declarative abstraction on top of the existing active geo-replication feature, Auto-failover groups are a SQL Database feature that allows you to manage replication and failover of a group of databases on a SQL Database server or all databases in a managed instance to another region.
They are designed to simplify deployment and management of geo-replicated databases at scale.</p> <p>When you are using auto-failover groups with automatic failover policy, any outage that impacts one or several of the databases in the group results in automatic failover. Typically these are incidents that cannot be self-mitigated by the built-in automatic high availability operations. The examples of failover triggers include an incident caused by a SQL tenant ring or control ring being down due to an OS kernel memory leak on several compute nodes, or an incident caused by one or more tenant rings being down because a wrong network cable was cut during routine hardware decommissioning. For more information, see SQL Database High Availability.</p> <ol><li>Create another Azure SQL Server in another azure region</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>az sql server create --name <span class="token operator">&lt;</span>name of your second server<span class="token operator">&gt;</span> --resource-group adc-sql-db-rg --location northeurope --admin-user <span class="token operator">&lt;</span>name of your admin<span class="token operator">&gt;</span> --admin-password <span class="token operator">&lt;</span>pwd<span class="token operator">&gt;</span>
</code></pre></div><ol start="2"><li>Create a failover group between the servers and add the database</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>az sql failover-group create --name <span class="token operator">&lt;</span>name of your fg<span class="token operator">&gt;</span> --partner-server <span class="token operator">&lt;</span>name of your second server<span class="token operator">&gt;</span> --resource-group adc-sql-db-rg --server <span class="token operator">&lt;</span>name of your server<span class="token operator">&gt;</span> --add-db MSFTEmployees --failover-policy Automatic
</code></pre></div><ol start="3"><li>Verify which server is secondary</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>az sql failover-group list --server <span class="token operator">&lt;</span>name of your server<span class="token operator">&gt;</span> --resource-group adc-sql-db-rg
</code></pre></div><ol start="4"><li>Failover to the secondary server</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>az sql failover-group set-primary --name <span class="token operator">&lt;</span>name of your fg<span class="token operator">&gt;</span> --resource-group adc-sql-db-rg --server <span class="token operator">&lt;</span>name of your second server<span class="token operator">&gt;</span>
</code></pre></div><ol start="5"><li>Revert failover group back to the primary server</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>az sql failover-group set-primary --name <span class="token operator">&lt;</span>name of your fg<span class="token operator">&gt;</span> --resource-group adc-sql-db-rg --server <span class="token operator">&lt;</span>name of your server<span class="token operator">&gt;</span>
</code></pre></div><p>Take a look at the failover group in the Azure portal. Find your SQL server. Under Data management select Failover groups. Select your failover group. You will see something like this:</p> <p><img src="/trainingdays/assets/img/sqlfailovergroup.1a672e8b.png" alt="Failover Group in the Azure portal"></p> <ol start="6"><li>Delete the resources you created in this challenge if you do not want to go through the optional content</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>az group delete --resource-group adc-sql-db-rg
</code></pre></div><h2 id="add-data-to-sql-db-using-the-azure-data-studio-optional"><a href="#add-data-to-sql-db-using-the-azure-data-studio-optional" class="header-anchor">#</a> Add Data to SQL DB using the Azure Data Studio (optional)</h2> <p>Another, more simple approach to add data to your Azure SQL database is using the Azure Data Studio. Azure Data Studio is a cross-platform database tool for data professionals using the Microsoft family of on-premises and cloud data platforms on Windows, MacOS, and Linux.</p> <p>Azure Data Studio offers a modern editor experience with IntelliSense, code snippets, source control integration, and an integrated terminal. It's engineered with the data platform user in mind, with built-in charting of query result sets and customizable dashboards.</p> <ol><li>Open the <code>Azure Data Studio</code> and connect to your server:</li></ol> <p><img src="/trainingdays/assets/img/azure-data-studio-connect.b41dff71.png" alt="Azure Data Studio"></p> <ol start="2"><li>After you have connected to your server, <code>Azure Data Studio</code> wants you to add your Azure account. Follow the instructions and add your account.
Next we want to create our first table in the MSFTEmployee. Navigate to the MSFTEmployee, open the context menu and select <code>New Query</code>.</li></ol> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>üìù If your server is not detected under your account you might need to renew the firewall-rule again.</p> <div class="language-shell extra-class"><pre class="language-shell"><code>az sql server firewall-rule create --server <span class="token operator">&lt;</span>name of your server<span class="token operator">&gt;</span> --resource-group adc-sql-db-rg --name AllowYourIp --start-ip-address <span class="token operator">&lt;</span>your public ip<span class="token operator">&gt;</span> --end-ip-address <span class="token operator">&lt;</span>your public Ip<span class="token operator">&gt;</span>
</code></pre></div></div> <p><img src="/trainingdays/assets/img/azure-data-studio-new-query.1eba088b.png" alt="New Query"></p> <ol start="2"><li>Add and run the following query, creating a new Table:</li></ol> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> PrtnrEmployees <span class="token punctuation">(</span>EmployerID <span class="token keyword">int</span><span class="token punctuation">,</span> LastName <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span> FirstName <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span> PartnerCompany <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span> StartYear <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ol start="3"><li>Create a new query and insert additional contacts :</li></ol> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> PrtnrEmployees <span class="token punctuation">(</span>EmployerID<span class="token punctuation">,</span> LastName<span class="token punctuation">,</span> FirstName<span class="token punctuation">,</span> PartnerCompany<span class="token punctuation">,</span> StartYear<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ol start="4"><li>View the data returned by a query</li></ol> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> PrtnrEmployees<span class="token punctuation">;</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> CEOs<span class="token punctuation">;</span>
</code></pre></div><h2 id="access-management-for-azure-sql-db-optional"><a href="#access-management-for-azure-sql-db-optional" class="header-anchor">#</a> Access Management for Azure SQL DB (optional)</h2> <p>Under Access Management we are taking a look at authentication and authorization. <em>Authentication</em> is the process of proving the users are who they claim to be. <em>Authorization</em> refers to the permissions assigned to a user within an Azure SQL Database, and determines what the user is allowed to do.</p> <p>Azure SQL Database supports two types of authentication: SQL authentication, as we have used before in creating the TestUser. And Azure Active Directory authentication.</p> <p>Let's have a look at the SQL authentication. As server admin you can create additional SQL users - which enables other users to connect to the SQL Database. Create a new query.</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">USER</span> Marvin <span class="token keyword">WITH</span> PASSWORD <span class="token operator">=</span> <span class="token string">'42_as_ANSWER!'</span><span class="token punctuation">;</span>
</code></pre></div><p>Now you can sign up as this user.</p> <p>Before we did grant the <code>TestUser</code> select access to the Table CEOs. Similarly you can create a custom role. There is also a set of fixed roles. They can be assigned as followes:</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">ALTER</span> ROLE  db_backupoperator <span class="token keyword">ADD</span> MEMBER Marvin<span class="token punctuation">;</span>
</code></pre></div><p><img src="/trainingdays/assets/img/permissions-of-database-roles.163bc268.png" alt="Fixed Rules"></p> <h2 id="connect-the-azure-sql-db-to-a-web-application-optional"><a href="#connect-the-azure-sql-db-to-a-web-application-optional" class="header-anchor">#</a> Connect the Azure SQL DB to a Web Application (optional)</h2> <p>This tutorial shows how to create a .NET Core app and connect it to a SQL Database. When you're done, you'll have a .NET Core MVC app running in App Service.</p> <ol><li>Clone the sample application</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">git</span> clone https://github.com/azure-samples/dotnetcore-sqldb-tutorial
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code><span class="token builtin class-name">cd</span> dotnetcore-sqldb-tutorial
</code></pre></div><ol start="2"><li>Install the required packages, run database migrations, and start the application.</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>   dotnet tool <span class="token function">install</span> --global dotnet-ef
   dotnet restore
   dotnet ef database update
   dotnet run
</code></pre></div><ol start="3"><li><p>Navigate to <code>http://localhost:5000</code> in a browser. Select the Create New link and create a couple to-do items. To stop .NET Core at any time, press <code>Ctrl+C</code> in the terminal.</p></li> <li><p>Create a new database in the previously created SQL Server.</p></li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>az sql db create --resource-group adc-sql-db-rg --server <span class="token operator">&lt;</span>name of your server<span class="token operator">&gt;</span> --name coreDB
</code></pre></div><ol start="5"><li>Create the connection string</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>az sql db show-connection-string --name coreDB --server <span class="token operator">&lt;</span>name of your server<span class="token operator">&gt;</span> --client sqlcmd
</code></pre></div><ol start="6"><li>The result should look something like this:</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token assign-left variable">Server</span><span class="token operator">=</span>tcp:<span class="token operator">&lt;</span>name of your server<span class="token operator">&gt;</span>.database.windows.net,1433<span class="token punctuation">;</span><span class="token assign-left variable">Database</span><span class="token operator">=</span>coreDB<span class="token punctuation">;</span>User <span class="token assign-left variable">ID</span><span class="token operator">=</span><span class="token operator">&lt;</span>name of your admin<span class="token operator">&gt;</span><span class="token punctuation">;</span><span class="token assign-left variable">Password</span><span class="token operator">=</span><span class="token operator">&lt;</span>pwd<span class="token operator">&gt;</span><span class="token punctuation">;</span><span class="token assign-left variable">Encrypt</span><span class="token operator">=</span>true<span class="token punctuation">;</span>Connection <span class="token assign-left variable">Timeout</span><span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">;</span>
</code></pre></div><ol start="7"><li>Configure a local git deployment. FTP and local Git can deploy to an Azure web app by using a deployment user. Once you configure your deployment user, you can use it for all your Azure deployments.</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>az webapp deployment user <span class="token builtin class-name">set</span> --user-name <span class="token operator">&lt;</span>name of your app user<span class="token operator">&gt;</span> --password <span class="token operator">&lt;</span>pwd<span class="token operator">&gt;</span>
</code></pre></div><ol start="8"><li>Create an App Service plan. An App Service plan defines a set of compute resources for a web app to run. These compute resources are analogous to the server farm in conventional web hosting. One or more apps can be configured to run on the same computing resources (or in the same App Service plan).</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>az appservice plan create --name <span class="token operator">&lt;</span>name of your asp<span class="token operator">&gt;</span> --resource-group adc-sql-db-rg --sku FREE
</code></pre></div><ol start="9"><li>Create a web app in the recently created App Service plan.</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>az webapp create --resource-group adc-sql-db-rg --plan <span class="token operator">&lt;</span>name of your asp<span class="token operator">&gt;</span> --name <span class="token operator">&lt;</span>your app name<span class="token operator">&gt;</span> --deployment-local-git
</code></pre></div><ol start="10"><li>Configure the connection string. To set connection strings for your Azure app, use the az webapp config appsettings set command in the Cloud Shell. In the following command replace the [Your Connection String] parameter with the connection string you created earlier.</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>az webapp config connection-string <span class="token builtin class-name">set</span> --resource-group adc-sql-db-rg --name <span class="token operator">&lt;</span>name of your app<span class="token operator">&gt;</span> --settings <span class="token assign-left variable">MyDbConnection</span><span class="token operator">=</span><span class="token string">&quot;&lt;Your Connection String&gt;&quot;</span> --connection-string-type SQLServer
</code></pre></div><ol start="11"><li>In ASP.NET Core, you can use this named connection string (<code>MyDbConnection</code>) using the standard pattern, like any connection string specified in <code>appsettings.json</code>. In this case, <code>MyDbConnection</code> is also defined in your <code>appsettings.json</code>. When running in App Service, the connection string defined in App Service takes precedence over the connection string defined in your <code>appsettings.json</code>. The code uses the appsettings.json value during local development, and the same code uses the App Service value when deployed.</li></ol> <p>Configure environment variable. Next, set <code>ASPNETCORE_ENVIRONMENT</code> app setting to Production. This setting lets you know whether you're running in Azure, because you use SQLite for your local development environment and SQL Database for your Azure environment.</p> <div class="language-shell extra-class"><pre class="language-shell"><code>az webapp config appsettings <span class="token builtin class-name">set</span> --name <span class="token operator">&lt;</span>name of your app<span class="token operator">&gt;</span> --resource-group adc-sql-db-rg --settings <span class="token assign-left variable">ASPNETCORE_ENVIRONMENT</span><span class="token operator">=</span><span class="token string">&quot;Production&quot;</span>
</code></pre></div><ol start="12"><li>Connect to SQL Database in production by opening the Startup.cs and finding the following code in your local repository:</li></ol> <div class="language-csharp extra-class"><pre class="language-csharp"><code>services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddDbContext</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>MyDatabaseContext<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>options <span class="token operator">=&gt;</span>
     options<span class="token punctuation">.</span><span class="token function">UseSqlite</span><span class="token punctuation">(</span><span class="token string">&quot;Data Source=localdatabase.db&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ol start="13"><li>Replace it with the following code, which uses the environment variables that you configured earlier.</li></ol> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token comment">// Use SQL Database if in Azure, otherwise, use SQLite</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>Environment<span class="token punctuation">.</span><span class="token function">GetEnvironmentVariable</span><span class="token punctuation">(</span><span class="token string">&quot;ASPNETCORE_ENVIRONMENT&quot;</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">&quot;Production&quot;</span><span class="token punctuation">)</span>
     services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddDbContext</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>MyDatabaseContext<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>options <span class="token operator">=&gt;</span>
         options<span class="token punctuation">.</span><span class="token function">UseSqlServer</span><span class="token punctuation">(</span>Configuration<span class="token punctuation">.</span><span class="token function">GetConnectionString</span><span class="token punctuation">(</span><span class="token string">&quot;MyDbConnection&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">else</span>
     services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddDbContext</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>MyDatabaseContext<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>options <span class="token operator">=&gt;</span>
         options<span class="token punctuation">.</span><span class="token function">UseSqlite</span><span class="token punctuation">(</span><span class="token string">&quot;Data Source=localdatabase.db&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">// Automatically perform database migration</span>
   services<span class="token punctuation">.</span><span class="token function">BuildServiceProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetService</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>MyDatabaseContext<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Database<span class="token punctuation">.</span><span class="token function">Migrate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>If this code detects that it's running in production (which indicates the Azure environment), then it uses the connection string you configured to connect to the SQL Database.</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>üìù The <code>Database.Migrate()</code> call helps you when it's run in Azure, because it automatically creates the databases that your .NET Core app needs, based on its migration configuration.</p></div> <ol start="14"><li>Save your changes, then commit it into your Git repository.</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">git</span> <span class="token function">add</span> <span class="token builtin class-name">.</span>
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">git</span> commit -m <span class="token string">&quot;connect to SQL DB in Azure&quot;</span>
</code></pre></div><ol start="15"><li>Push to Azure from Git. Add an Azure remote to your local Git repository. Replace [Local Git URL] with the URL of the Git remote from step 7, when ypu did create the web app.</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">git</span> remote <span class="token function">add</span> azure <span class="token operator">&lt;</span>Local Git URL<span class="token operator">&gt;</span>
</code></pre></div><ol start="16"><li>Push to the Azure remote to deploy your app with the following command. When Git Credential Manager prompts you for credentials, make sure you enter the credentials you created in Configure a deployment user, not the credentials you use to sign in to the Azure portal. This might take some time.</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">git</span> push azure master
</code></pre></div><ol start="17"><li>Browse to the deployed app using your web browser.</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>http://<span class="token operator">&lt;</span>name of your app<span class="token operator">&gt;</span>.azurewebsites.net
</code></pre></div><h2 id="cleanup"><a href="#cleanup" class="header-anchor">#</a> Cleanup</h2> <p>Remove the sample resource group:</p> <div class="language-shell extra-class"><pre class="language-shell"><code>az group delete --name adc-sql-db-rg
</code></pre></div><p><a href="/trainingdays/day3/challenges/01-challenge-cosmosdb.html">‚óÄ Previous challenge</a> | <a href="/trainingdays/day3/" class="router-link-active">üîº Day 3</a> | <a href="/trainingdays/day3/challenges/03-challenge-search.html">Next challenge ‚ñ∂</a></p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/azuredevcollege/trainingdays/edit/master/day3/challenges/02-challenge-sql.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/trainingdays/assets/js/app.f35de7a7.js" defer></script><script src="/trainingdays/assets/js/2.989cf5bf.js" defer></script><script src="/trainingdays/assets/js/25.83c4ee46.js" defer></script>
  </body>
</html>
