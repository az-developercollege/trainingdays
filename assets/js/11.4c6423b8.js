(window.webpackJsonp=window.webpackJsonp||[]).push([[11],{363:function(e,t,r){e.exports=r.p+"assets/img/deploytoazure.e0e5d477.png"},446:function(e,t,r){e.exports=r.p+"assets/img/goal.6e03abe2.png"},447:function(e,t,r){e.exports=r.p+"assets/img/onpremise.f1d33cab.png"},448:function(e,t,r){e.exports=r.p+"assets/img/vpnLabAzureStart.6306c9ad.png"},449:function(e,t,r){e.exports=r.p+"assets/img/vpnGWPIP.ef0fe4eb.png"},450:function(e,t,r){e.exports=r.p+"assets/img/connectionFlow.8657ae70.png"},451:function(e,t,r){e.exports=r.p+"assets/img/vpn0.b2dfe067.png"},452:function(e,t,r){e.exports=r.p+"assets/img/vpn1.ceece175.png"},453:function(e,t,r){e.exports=r.p+"assets/img/vpn2.c2bae65a.png"},454:function(e,t,r){e.exports=r.p+"assets/img/vpn3.5e26f77c.png"},455:function(e,t,r){e.exports=r.p+"assets/img/vpn4.9caf3813.png"},456:function(e,t,r){e.exports=r.p+"assets/img/vpn5.dad472fd.png"},457:function(e,t,r){e.exports=r.p+"assets/img/successfulPing.96d6310b.png"},458:function(e,t,r){e.exports=r.p+"assets/img/vpn6-moresecure.5fa353ef.png"},846:function(e,t,r){"use strict";r.r(t);var a=r(28),n=Object(a.a)({},(function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("h1",{attrs:{id:"challenge-8-networking-and-vpn-enabling-hybrid-networking-with-a-site-2-site-onprem-to-azure-vpn-connection"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#challenge-8-networking-and-vpn-enabling-hybrid-networking-with-a-site-2-site-onprem-to-azure-vpn-connection"}},[e._v("#")]),e._v(" Challenge 8: Networking and VPN - Enabling Hybrid Networking with a Site-2-Site (Onprem to Azure) VPN Connection")]),e._v(" "),a("h2",{attrs:{id:"here-is-what-you-will-learn-ðŸŽ¯"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#here-is-what-you-will-learn-ðŸŽ¯"}},[e._v("#")]),e._v(" Here is what you will learn ðŸŽ¯")]),e._v(" "),a("p",[e._v("What it takes to implement a VPN tunnel between your onprem firewall <---VPN S2S---\x3e Azure. Our final architecture will look like this:"),a("br"),e._v(" "),a("img",{attrs:{src:r(446),alt:"Hybrid Network with Azure"}})]),e._v(" "),a("p",[e._v("An Azure S2S VPN requires:")]),e._v(" "),a("table",[a("thead",[a("tr",[a("th",[e._v("onprem")]),e._v(" "),a("th",[e._v("Azure")])])]),e._v(" "),a("tbody",[a("tr",[a("td",[e._v("A supported device Azure can talk to.")]),e._v(" "),a("td",[a("ul",[a("li",[e._v("VPN Gateway in its own subnet.")]),a("li",[e._v("VPN GWay requires a dynamic Public IP")]),a("li",[e._v("Settings how the onprem VPN / FWall is to be contacted (aka LocalNetworkGateway)")]),a("li",[e._v("Connection Object with e.g. shared key")])])])])])]),e._v(" "),a("h2",{attrs:{id:"table-of-contents"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#table-of-contents"}},[e._v("#")]),e._v(" Table of Contents")]),e._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"#challenge-8-networking-and-vpn---enabling-hybrid-networking-with-a-site-2-site-onprem-to-azure-vpn-connection"}},[e._v("Challenge 8: Networking and VPN - Enabling Hybrid Networking with a Site-2-Site (Onprem to Azure) VPN Connection")]),e._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"#here-is-what-you-will-learn-"}},[e._v("Here is what you will learn ðŸŽ¯")])]),e._v(" "),a("li",[a("a",{attrs:{href:"#table-of-contents"}},[e._v("Table of Contents")])]),e._v(" "),a("li",[a("a",{attrs:{href:"#starting-point"}},[e._v("Starting Point")])]),e._v(" "),a("li",[a("a",{attrs:{href:"#create-a-vpn-gateway-and-a-public-ip-using-the-azure-portal"}},[e._v("Create a VPN Gateway and a Public IP using the Azure portal")])]),e._v(" "),a("li",[a("a",{attrs:{href:"#create-a-local-network-gateway-in-azure"}},[e._v("Create a Local Network Gateway in Azure")])]),e._v(" "),a("li",[a("a",{attrs:{href:"#create-a-connection-object-with-shared-key-in-azure"}},[e._v("Create a connection object with shared key in Azure")])]),e._v(" "),a("li",[a("a",{attrs:{href:"#configure-your-onpremise-vpn-counterpart"}},[e._v("Configure your onpremise VPN counterpart")])]),e._v(" "),a("li",[a("a",{attrs:{href:"#apply-a-more-secure-cipher-for-the-vpn-tunnel-optional"}},[e._v("Apply a more secure cipher for the VPN tunnel (optional)")])]),e._v(" "),a("li",[a("a",{attrs:{href:"#cleanup"}},[e._v("Cleanup")])])])])]),e._v(" "),a("h2",{attrs:{id:"starting-point"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#starting-point"}},[e._v("#")]),e._v(" Starting Point")]),e._v(" "),a("p",[e._v("Your instructor has setup for you the onprem part - "),a("em",[e._v("ask him for the details")]),e._v(":")]),e._v(" "),a("p",[a("img",{attrs:{src:r(447),alt:"Onpremise"}})]),e._v(" "),a("p",[a("strong",[e._v("Click")]),e._v(" on the "),a("a",{attrs:{href:"https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2Fazuredevcollege%2Ftrainingdays%2Fmaster%2Fday1%2Fchallenge-08%2Fchallengestart%2Fchallengestart.json"}},[a("img",{attrs:{src:r(363)}})]),e._v("\nbutton to get the Azure resources to start with:"),a("br"),e._v(" "),a("img",{attrs:{src:r(448),alt:"azure vpn starting point"}})]),e._v(" "),a("table",[a("thead",[a("tr",[a("th",[e._v("Name")]),e._v(" "),a("th",[e._v("Value")])])]),e._v(" "),a("tbody",[a("tr",[a("td",[a("em",[e._v("Resource group")])]),e._v(" "),a("td",[a("strong",[e._v("(new)")]),e._v(" rg-vpn")])]),e._v(" "),a("tr",[a("td",[a("em",[e._v("Location")])]),e._v(" "),a("td",[e._v("North Europe")])]),e._v(" "),a("tr",[a("td",[a("em",[e._v("Admin user")])]),e._v(" "),a("td",[e._v("demouser")])]),e._v(" "),a("tr",[a("td",[a("em",[e._v("Admin password")])]),e._v(" "),a("td",[e._v("%some complex value%")])]),e._v(" "),a("tr",[a("td",[a("em",[e._v("Vm Size")])]),e._v(" "),a("td",[e._v("Standard_B2s or try e.g. Standard_F2s_v2")])]),e._v(" "),a("tr",[a("td",[a("em",[e._v("Disk Sku")])]),e._v(" "),a("td",[e._v("StandardSSD_LRS")])])])]),e._v(" "),a("h2",{attrs:{id:"create-a-vpn-gateway-and-a-public-ip-using-the-azure-portal"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#create-a-vpn-gateway-and-a-public-ip-using-the-azure-portal"}},[e._v("#")]),e._v(" Create a VPN Gateway and a Public IP using the Azure portal")]),e._v(" "),a("p",[a("code",[e._v("[Azure Portal] -> '+ Create a resource' -> type \"Virtual network gateway\" -> Create")])]),e._v(" "),a("p",[e._v("Use the following parameter values:")]),e._v(" "),a("table",[a("thead",[a("tr",[a("th",[e._v("Parameter Name")]),e._v(" "),a("th",[e._v("Values")])])]),e._v(" "),a("tbody",[a("tr",[a("td",[a("em",[e._v("Name")])]),e._v(" "),a("td",[e._v("myAzVPNGWay")])]),e._v(" "),a("tr",[a("td",[a("em",[e._v("Region")])]),e._v(" "),a("td",[e._v("North Europe")])]),e._v(" "),a("tr",[a("td",[a("em",[e._v("Gateway type")])]),e._v(" "),a("td",[e._v("VPN")])]),e._v(" "),a("tr",[a("td",[a("em",[e._v("VPN Type")])]),e._v(" "),a("td",[e._v("Route based")])]),e._v(" "),a("tr",[a("td",[a("em",[e._v("Gateway type")])]),e._v(" "),a("td",[e._v("VPN")])]),e._v(" "),a("tr",[a("td",[a("em",[e._v("SKU")])]),e._v(" "),a("td",[e._v("VpnGw1")])]),e._v(" "),a("tr",[a("td",[a("em",[e._v("Virtual Network")])]),e._v(" "),a("td",[e._v("vnet-vpn")])]),e._v(" "),a("tr",[a("td",[a("em",[e._v("Gateway subnet address range")])]),e._v(" "),a("td",[e._v("e.g. 10.1.254.192/26")])]),e._v(" "),a("tr",[a("td",[a("em",[e._v("Public IP address")])]),e._v(" "),a("td",[a("strong",[e._v("Create new")])])]),e._v(" "),a("tr",[a("td",[a("em",[e._v("Public IP address name")])]),e._v(" "),a("td",[e._v("myAzVPNGWay-IP")])]),e._v(" "),a("tr",[a("td",[a("em",[e._v("Enable active-active mode")])]),e._v(" "),a("td",[e._v("Disabled")])]),e._v(" "),a("tr",[a("td",[a("em",[e._v("Configure BGP")])]),e._v(" "),a("td",[e._v("Disabled")])])])]),e._v(" "),a("p",[e._v("The GW setup will take approx 30 mins. to create. So come back later (e.g. in the meantime you can do the next lab ðŸ˜ƒ)")]),e._v(" "),a("p",[e._v("When your GW has been assigned a "),a("em",[e._v("public IP address")]),e._v(" then you know it is online.")]),e._v(" "),a("p",[a("img",{attrs:{src:r(449),alt:"VPN GW with public IP"}})]),e._v(" "),a("h2",{attrs:{id:"create-a-local-network-gateway-in-azure"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#create-a-local-network-gateway-in-azure"}},[e._v("#")]),e._v(" Create a Local Network Gateway in Azure")]),e._v(" "),a("p",[e._v("The purpose of this task is to tell Azure how to contact the onpremise firewall:")]),e._v(" "),a("p",[a("code",[e._v("[Azure Portal] -> '+ Add' -> type 'Local network gateway' -> Create")])]),e._v(" "),a("table",[a("thead",[a("tr",[a("th",[e._v("Parameter Name")]),e._v(" "),a("th",[e._v("Values")])])]),e._v(" "),a("tbody",[a("tr",[a("td",[a("em",[e._v("Name")])]),e._v(" "),a("td",[e._v("l-gw-ipfire")])]),e._v(" "),a("tr",[a("td",[a("em",[e._v("IP address")])]),e._v(" "),a("td",[e._v("%external IP of your Firewall - ask instructor%")])]),e._v(" "),a("tr",[a("td",[a("em",[e._v("Address Space")])]),e._v(" "),a("td",[e._v("192.168.0.0/24")])]),e._v(" "),a("tr",[a("td",[a("em",[e._v("Resource Group")])]),e._v(" "),a("td",[e._v("rg-vpn")])]),e._v(" "),a("tr",[a("td",[a("em",[e._v("Location")])]),e._v(" "),a("td",[e._v("North Europe")])])])]),e._v(" "),a("h2",{attrs:{id:"create-a-connection-object-with-shared-key-in-azure"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#create-a-connection-object-with-shared-key-in-azure"}},[e._v("#")]),e._v(" Create a connection object with shared key in Azure")]),e._v(" "),a("p",[a("code",[e._v("[Azure Portal] -> Resource Groups -> rg-vpn -> myAzVPNGWay -> Connections")])]),e._v(" "),a("table",[a("thead",[a("tr",[a("th",[e._v("Parameter Name")]),e._v(" "),a("th",[e._v("Values")])])]),e._v(" "),a("tbody",[a("tr",[a("td",[a("em",[e._v("Name")])]),e._v(" "),a("td",[e._v("azure-to-onprem")])]),e._v(" "),a("tr",[a("td",[a("em",[e._v("Connection Type")])]),e._v(" "),a("td",[e._v("Site-to-Site (IPSec)")])]),e._v(" "),a("tr",[a("td",[a("em",[e._v("Virtual Network Gateway")])]),e._v(" "),a("td",[e._v("myAzVPNGWay")])]),e._v(" "),a("tr",[a("td",[a("em",[e._v("Local Network Gateway")])]),e._v(" "),a("td",[e._v("l-gw-ipfire")])]),e._v(" "),a("tr",[a("td",[a("em",[e._v("Shared Key")])]),e._v(" "),a("td",[e._v("%your choice here%")])]),e._v(" "),a("tr",[a("td",[a("em",[e._v("IKE Protocol")])]),e._v(" "),a("td",[e._v("IKEv2")])]),e._v(" "),a("tr",[a("td",[a("em",[e._v("Resource Group")])]),e._v(" "),a("td",[e._v("rg-vpn")])]),e._v(" "),a("tr",[a("td",[a("em",[e._v("Location")])]),e._v(" "),a("td",[e._v("North Europe")])])])]),e._v(" "),a("h2",{attrs:{id:"configure-your-onpremise-vpn-counterpart"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#configure-your-onpremise-vpn-counterpart"}},[e._v("#")]),e._v(" Configure your onpremise VPN counterpart")]),e._v(" "),a("p",[e._v("We now need to configure the other end of the vpn tunnel: the onpremise firewall in our case a linux FW called "),a("em",[e._v("IPFire")]),e._v(".")]),e._v(" "),a("ol",[a("li",[e._v("For this use the remote desktop client to RDP into your onpremise environment ("),a("em",[e._v("ask your instructor for connection details")]),e._v("):")])]),e._v(" "),a("p",[a("code",[e._v("Internet -- 1st RDP -> onprem Lab (HyperV Host) -- 2nd RDP -> cmW2k19 (192.168.0.11) --https -> IPFire (192.168.0.100)")])]),e._v(" "),a("p",[a("img",{attrs:{src:r(450),alt:"Connection Flow"}})]),e._v(" "),a("table",[a("thead",[a("tr",[a("th",[e._v("Parameter Name")]),e._v(" "),a("th",[e._v("Values")])])]),e._v(" "),a("tbody",[a("tr",[a("td",[a("em",[e._v("connect to 1st RDP")])]),e._v(" "),a("td",[a("ul",[a("li",[a("b",[e._v("IP")]),e._v(": %ask instructor%")]),a("li",[a("b",[e._v("username")]),e._v(": demouser")]),a("li",[a("b",[e._v("password")]),e._v(": %ask instructor%")])])])]),e._v(" "),a("tr",[a("td",[a("em",[e._v("within this session connect to 2nd RDP")])]),e._v(" "),a("td",[a("ul",[a("li",[a("b",[e._v("IP")]),e._v(": 192.168.0.11")]),a("li",[a("b",[e._v("username")]),e._v(": administrator")]),a("li",[a("b",[e._v("password")]),e._v(": %ask instructor%")])])])]),e._v(" "),a("tr",[a("td",[a("em",[e._v("open browser and do https")]),e._v(" ( ignore certificate warning -> proceed)")]),e._v(" "),a("td",[a("ul",[a("li",[a("b",[e._v("URI")]),e._v(": "),a("a",{attrs:{href:"https://192.168.0.100:444",target:"_blank",rel:"noopener noreferrer"}},[e._v("https://192.168.0.100:444"),a("OutboundLink")],1)]),a("li",[a("b",[e._v("username")]),e._v(": admin")]),a("li",[a("b",[e._v("password")]),e._v(": %ask instructor%")])])])])])]),e._v(" "),a("ol",{attrs:{start:"2"}},[a("li",[e._v("Add the VPN details and save")])]),e._v(" "),a("p",[a("code",[e._v("IPFire -> Services -> IPSec -> 'Connection Status and -Control' -> Add")])]),e._v(" "),a("p",[a("img",{attrs:{src:r(451),alt:"IPFire: Add a connection"}})]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('"Net-to-Net Virtual Private Network" -> Add\n')])])]),a("p",[a("img",{attrs:{src:r(452),alt:"IPFire: add Net-to-Net connection"}})]),e._v(" "),a("table",[a("thead",[a("tr",[a("th",[e._v("Parameter Name")]),e._v(" "),a("th",[e._v("Values")])])]),e._v(" "),a("tbody",[a("tr",[a("td",[a("em",[e._v("Name")])]),e._v(" "),a("td",[e._v("azure")])]),e._v(" "),a("tr",[a("td",[a("em",[e._v("Local subnet")])]),e._v(" "),a("td",[e._v("192.168.0.0/255.255.255.0")])]),e._v(" "),a("tr",[a("td",[a("em",[e._v("Remote Host/IP")])]),e._v(" "),a("td",[e._v("%myAzVPNGWay IP Address% (Azure Portal -> VPN Gateway -> Public IP address)")])]),e._v(" "),a("tr",[a("td",[a("em",[e._v("Remote subnet")])]),e._v(" "),a("td",[e._v("%Address Range of the virtual network in azure% (in our case 10.1.0.0/255.255.0.0)")])]),e._v(" "),a("tr",[a("td",[a("em",[e._v("Use a pre-shared key")])]),e._v(" "),a("td",[e._v("%Shared Key you used above% (Azure Portal -> VPN Gateway -> Connections -> Shared Key)")])])])]),e._v(" "),a("p",[a("img",{attrs:{src:r(453),alt:"IPFire: connection settings"}})]),e._v(" "),a("ol",{attrs:{start:"3"}},[a("li",[e._v("Modify the algorithms used for the connection. Click on the pencil symbol and choose 'Advanced':")])]),e._v(" "),a("p",[a("img",{attrs:{src:r(454),alt:"IPFire: Advanced cipher settings"}})]),e._v(" "),a("p",[e._v("3.1 You "),a("em",[e._v("must")]),e._v(" select the following algorithms/suites for the connection:")]),e._v(" "),a("p",[a("img",{attrs:{src:r(455),alt:"IPFire: connection settings"}})]),e._v(" "),a("p",[e._v("3.2 Select "),a("code",[e._v("Always on")]),e._v(", then save")]),e._v(" "),a("p",[e._v("3.3 Tick checkbox to enable connection. The connection status should go to green:")]),e._v(" "),a("p",[a("img",{attrs:{src:r(456),alt:"IPFire: connection settings"}})]),e._v(" "),a("ol",{attrs:{start:"4"}},[a("li",[e._v("Now let's ping your Azure VM (e.g. vmazure) under its private ip (probably: 10.1.0.4) from onpremise:")])]),e._v(" "),a("p",[a("img",{attrs:{src:r(457),alt:"Successful Ping"}}),e._v("\nDo you receive a response?")]),e._v(" "),a("h2",{attrs:{id:"apply-a-more-secure-cipher-for-the-vpn-tunnel-optional"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#apply-a-more-secure-cipher-for-the-vpn-tunnel-optional"}},[e._v("#")]),e._v(" Apply a more secure cipher for the VPN tunnel (optional)")]),e._v(" "),a("p",[e._v("The following ARM Template ("),a("a",{attrs:{href:"./scripts/VPNMoreSecureConnPolicy.json"}},[e._v("VPNMoreSecureConnPolicy.json")]),e._v(") defines a more secure cipher / algorithm to use for the VPN tunnel:")]),e._v(" "),a("table",[a("thead",[a("tr",[a("th",[e._v("Parameter Name")]),e._v(" "),a("th",[e._v("Values")])])]),e._v(" "),a("tbody",[a("tr",[a("td",[a("em",[e._v("ipsecEncryption")])]),e._v(" "),a("td",[e._v("AES256")])]),e._v(" "),a("tr",[a("td",[a("em",[e._v("ipsecIntegrity")])]),e._v(" "),a("td",[e._v("SHA256")])]),e._v(" "),a("tr",[a("td",[a("em",[e._v("ikeEncryption")])]),e._v(" "),a("td",[e._v("AES256")])]),e._v(" "),a("tr",[a("td",[a("em",[e._v("ikeIntegrity")])]),e._v(" "),a("td",[e._v("SHA384")])]),e._v(" "),a("tr",[a("td",[a("em",[e._v("dhGroup")])]),e._v(" "),a("td",[e._v("DHGroup14")])]),e._v(" "),a("tr",[a("td",[a("em",[e._v("pfsGroup")])]),e._v(" "),a("td",[e._v("PFS2048")])])])]),e._v(" "),a("p",[e._v("To deploy it, "),a("strong",[e._v("click")]),e._v(" the\n"),a("a",{attrs:{href:"https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2Fazuredevcollege%2Ftrainingdays%2Fmaster%2Fday1%2Fchallenges%2FChallenge8%2FVPNMoreSecureConnPolicy.json"}},[a("img",{attrs:{src:r(363)}})]),e._v(" button and select correct parameters to apply new ciphers to your current connection.")]),e._v(" "),a("p",[e._v("However, you also need to apply this to the onprem firewall:")]),e._v(" "),a("p",[a("img",{attrs:{src:r(458),alt:"VPN more secure cipher"}})]),e._v(" "),a("h2",{attrs:{id:"cleanup"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#cleanup"}},[e._v("#")]),e._v(" Cleanup")]),e._v(" "),a("p",[e._v("Delete the resource group "),a("code",[e._v("rg-vpn")])]),e._v(" "),a("p",[a("RouterLink",{attrs:{to:"/day1/challenge-07/"}},[e._v("â—€ Previous challenge")]),e._v(" | "),a("RouterLink",{attrs:{to:"/day1/"}},[e._v("ðŸ”¼ Day 1")]),e._v(" | "),a("RouterLink",{attrs:{to:"/day1/challenge-09/"}},[e._v("Next challenge â–¶")])],1)])}),[],!1,null,null,null);t.default=n.exports}}]);